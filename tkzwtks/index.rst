バランスwiiボードで健康管理
===============================================
アウトライン
------------
* 健康のためにWiiFit Uを買ったものの、Wiiを起動するのがめんどくさい
* Webで記録推移が見られないのに嫌気がさしたので自分でWebに投稿するか！
* 運動記録と体重変化が見られる
* この記事での「健康」とは？

はじめに
------------
どうも（たぶん）皆様初めまして。某ウェッブ企業にてweb以外のことをやってる @tkzwtks といいます。どうもどうも。
ところで皆さん、健康について真面目に考えてますか？僕は今年で31歳になったのですが、体重は100kg超です。ええ、肥満です。
さすがに最近「20代ならまだしも、30歳すぎて100kg超はまずいよなー。40になって減るとも思えないしなー」と思い始めました。遅いですね。
ふと周りを見ると「これで頑張って痩せるぞ！！」と思いながら買ったものの微妙にホコリをかぶっているバランスWiiボードが。
ということでバランスWiiボードやその他のWebサービスを使って健康管理にチャレンジです。

バランスwiiボード
^^^^^^^^^^^^^^^^^
ところで「バランスWiiボード」は皆さんご存知でしょうか。Wii/WiiUとつないで使える板状のコントローラです。

[このへんにバランスボードのしゃしん]

現在（2014年現在）だと「WiiFit U」とセットで販売されていて、遊ぶときもWiiFit Uで遊びます。
WiiFit UではバランスWiiボードの上に乗ることで体重を測ったり、ランニングっぽい何かをしたり、Wiiリモコンを持ってボクササイズ的なことができるのです。
さらに「WiiFitメーター」という万歩計的なものを使うことで「一日どれくらいの運動量があったか」を計測できるのです！
僕もこれを買うと決めた時は「これで毎日楽しく運動できる」「毎日ちょっとずつでも運動すれば痩せるぞ！」と息巻いていたのです。これは完全に余談ですがバランスwiiボードで測れる体重は136kgまでです。これも（僕にとっては）魅力的な点でした。
そうして最初はうちは頑張って毎日帰宅後にWiiUを起動し、体重を測り、ちょっとは運動してたのです。

ところが、いつくらいからだったかは全く覚えていませんが、ある時から全く乗らなくなってしまったのです。
一応今年こそ「健康になるぞ」と考えていた僕は、なぜ乗らなくなったのか理由を考えました。

* 体重を測るためにWiiUを起動しないといけない。WiiUを起動するだけではなくさらにソフトを立ち上げないといけない。
  * ディスク版を買ってしまったがゆえにマリオカート8と入れ替えるのが面倒
* 結果表示が曖昧。「太りすぎ」なんてことは十分自覚してるのでさっさと体重を教えて欲しい
* 記録したのをすぐに見られない。WiiUを起動しないと体重変化の推移を見ることができない。

リストアップしてみるとこんな理由が思い浮かびました。どれも要するに「面倒」というのが大きな理由のように思えます。
「記録するのも面倒」「結果を見るのも面倒」「つーか体重変化がどうなってるかを見たい時に見られないとかテンション下がる」みたいな感じですね。
つまり「面倒じゃない方法で」「最低でも体重だけは日々の増減が見られる」ようにすれば僕も続けらるかもしれないのです！
ということで今回は「体重を測ってWebに記録してくれる」仕組みを作ることにしました。

実際に作ってみた
------------------

概要
^^^^^^

今回は以下のようなものをつくります

[このへんに仕組みの概要図]

ご存知の方は多いと思いますが、バランスWiiボードはBluetoothでWiiUと接続し、コントローラとして使います。つまりバランスWiiボードと自宅にあるPC（今回はMacです）とつなげばバランスWiiボードの何らかのデータがとれるはずなのです。
今回はMac-バランスwiiボード間の通信に"OpenSound Control（以下OSC）"を使うことにしました。Mac用アプリケーションである「OSCulator」を利用し、OSCulatorで一旦バランスwiiボードの信号を受け、そこからOSCプロトコルで今回作るアプリケーションにデータをルーティングします。OSCulatorはWii系コントローラーとの接続に対応しており、特に何もせずにWii系コントローラーと接続して、コントローラーからのデータを受け取ることが可能です。
そしてアプリケーションではデータを受け取った後、体重を測定し、その結果を今回はFitbit.comに送信します。Fitbit.comをつかうのはWeb上で記録したものが見られるというのと、筆者がFitbit Zipを持っているというのが主な理由です。FitbitZipかわいいよFitbitZip。目標は毎日1万歩です。

OpenSound Control
^^^^^^^^^^^^^^^^^^

OpenSound Controlは、シンセサイザー等の電子楽器やコンピュータ間で、音楽の演奏データをネットワーク経由で共有するためのプロトコルです。MIDIの代替となることを目指して開発されました。OSCは簡易且つ柔軟なプロトコルのため、現在では電子楽器等だけでなく、様々なアプリケーションやハードウェアに実装されています。
OSCプロトコルは大きく分けて以下の2つのパートに分かれます。
* OSC Message
  * 「何を送るか」のラベリング
  * URLに似た形式で記述される
* OSC Arguments
  * 実際に送られる値
  * 様々な型を送信できる。また、複数の値を同時に送受信することも可能

[このへんにバランスWiiボードのOSCメッセージの例をあげる]

* バランスWiiボードで利用できるOSC Messageの例を挙げる

バランスWiiボードで実際に体重を取得する
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Macと接続！
+++++++++++
ではいよいよバランスWiiボードとMacをつないで体重を測ります。つなぐ方法、と言ってもほとんどやることはありません。OSCulatorを起動し、Wiimoteタブを開き、バランスWiiボードとペアリングするだけです。この時点でバランスWiiボードからの情報はとれるので、"Quick Look"ボタンを押せばセンシングの様子を確認できます。
  
データを受け取るアプリケーションを作る
++++++++++++++++++++++++++++++++++++++++++++
次はデータを受け取るためのアプリケーションを作ります。できるだけ簡単に作りたい、という気持ちもあり今回はnode.jsで作りました。node.jsのインストールだとか細かいお話については別の人や既に発売中の書籍に任せることにします。ググればすぐに出てくると思います。今回はnode.jsの開発環境がある程度揃っている前提でお話を進めることにします。
OSCulatorからRoutingされるデータを受け取るために、node.jsでUDPサーバーを立てて、それでOSC通信を行います。と言っても受信するだけですけど。
また、node.jsでOSCメッセージを処理するためにosc-min[#oscmin]というモジュールを作っている人がいるのでそれを利用します。

..code-block::console
  $ npm install osc-min

これでnode-osc-minを使う準備が出来ました。実際にコードを書いてみます。OSCulatorでRoutingされたメッセージを受信するためのコードはこんな感じです。

..code-block::javascript
  var osc = require('osc-min');
  var udp = require('dgram');

  sock = udp.createSocket("udp4", function(msg, rinfo) {
    var error;
    try {
      return console.log(osc.fromBuffer(msg));
    } catch (_error) {
      error = _error;
      return console.log("invalid OSC packet");
    }
  });

  sock.bind(9999);

こんな感じです。と言うよりはサンプルそのままです。これを実行するとUDPのサーバーを立ちあがり、OSCのパケットを受信できるようになります。実際に受信すると、コンソールに受信されたOSCメッセージが出力されます。上のコードでOSCに関連するコードは7行目の

..code-block::javascript
  osc.fromBuffer(msg)

だけです。このAPIは受け取ったパケットをJSONに変換してくれるものです。これでバランスWiiボードのデータが取れるようになりました。簡単ですね？


..[#oscmin] https://github.com/russellmcc/node-osc-min

使ってみた
^^^^^^^^^^^

体重に影響を与えるものの考察
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

結論
--------

* ある環境だと体重が一番落ちることが判明した

  * 天気や食事、仕事時間の関係
  * 運動するのに適した時間や強度、運動時間

* モチベーションを落とさずにやる方法はこれだ！！とかあるといいな
* ダブルピース写真ももれなく必要
